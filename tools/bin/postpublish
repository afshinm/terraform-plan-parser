#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const spawnSync = require('child_process').spawnSync;

const rootDir = path.join(__dirname, '../..');
const rootPackageFile = path.join(rootDir, 'package.json');
const rootPackageJson = fs.readFileSync(rootPackageFile, { encoding: 'utf8' });
const rootPackageObj = JSON.parse(rootPackageJson);

const distPackageJson = fs.readFileSync(path.join(__dirname, '../../work/dist/package.json'), {encoding: 'utf8'});
const distPackageObj = JSON.parse(distPackageJson);

rootPackageObj.version = distPackageObj.version;

const json = JSON.stringify(rootPackageObj, null, '  ');

fs.writeFileSync(rootPackageFile, json, { encoding: 'utf8' });

spawnSync('git', ['add', '.'], {
  cwd: rootDir
});

spawnSync('git', ['commit', '-m', `Published ${rootPackageObj.version}`], {
  cwd: rootDir
});

spawnSync('git', ['push'], {
  cwd: rootDir
});

const tagName = `v${rootPackageObj.version}`;

spawnSync('git', ['tag', tagName], {
  cwd: rootDir
});

spawnSync('git', ['push', 'origin', tagName], {
  cwd: rootDir
});
